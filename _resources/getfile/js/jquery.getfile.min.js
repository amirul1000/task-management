/*
 *	GetFile v2.2 - 2015-01-22
 *	jQuery Upload Plugin
 *	By Jose Carlos Rodriguez
 *	(c) 2014 Syscover S.L. - http://www.syscover.com/
 *	All rights reserved
 */
"use strict";(function(e){var t={options:{urlPlugin:".",folder:null,tmpFolder:null,encryption:false,filename:null,outputExtension:null,multiple:false,maxFileSize:false,maxFilesSizes:false,spinner:true,mimesAccept:["image/*","video/*","audio/*","text/plain","application/pdf","application/msword","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],crop:{active:false,width:null,height:null,aspectRatio:null,minSize:null,maxSize:null,setSelect:null},resize:{active:false,width:null,height:null,constrainProportions:true},copies:[],lang:{cropWindowTitle:"Cop image",previewTitle:"Preview",cropButtonText:"Crop",cancelButtonText:"Cancel"},selectorItems:{container:"#wrapGetFile",cropButton:"#gfCropButton",cancelButton:"#gfCancelButton",crop:".imgs-crop-container",preview:".imgs-preview-container"}},items:{container:null,cropButton:null,cancelButton:null,crop:null,preview:null},properties:{files:null,coords:null,tmpDelete:345600,tmpName:"",oldName:null,extension:null,mime:null,size:null,isImage:null,mow:null,moh:800,mpw:null,mph:800,row:null,roh:null,rpw:null,rph:null,width:null,height:null,pixelRatio:null,phpIni:null,response:null},callback:null,init:function(t,n,r){this.options=e.extend({},this.options,t||{});if(this.options.crop.active&&e(this.options.selectorItems.container).length==0){var i=this.options.lang;i.urlPlugin=t.urlPlugin;e.ajax({async:false,cache:false,dataType:"html",type:"POST",url:this.options.urlPlugin+"/getfile/views/popup.php",data:i,success:function(t){e("body").append(t)},error:function(e){var e={success:false,error:12,message:"The path: "+this.url+" in the ajax request is not correct, please check the ajax function data"};n(e)}})}e.ajax({async:false,url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:false,data:{action:"getvars"},success:function(e){this.properties.phpIni=e}});this.items={container:e(this.options.selectorItems.container),cropButton:e(this.options.selectorItems.cropButton),cancelButton:e(this.options.selectorItems.cancelButton),crop:e(this.options.selectorItems.crop),preview:e(this.options.selectorItems.preview)};if(t.mimesAccept){this.options.mimesAccept=t.mimesAccept}this.callback=n;this.elem=e(r);if(this.options.multiple){var s={multiple:true,logging:false}}else{var s={logging:false}}if(this.options.mimesAccept==false){window.fd.logging=false;fd.jQuery();e(this.elem).filedrop(s).filedrop().event("send",function(t){e.proxy(this.upload(t),this)}.bind(this))}else{if(Object.prototype.toString.call(this.options.mimesAccept)==="[object Array]"){window.fd.logging=false;fd.jQuery();e(this.elem).filedrop(s).filedrop().event("send",function(t){e.proxy(this.upload(t),this)}.bind(this))}else{var o={success:false,error:11,message:"The mimesAccept setting must be an array or false. Setting it to false might be dangerous, since it means accepting all file types"};if(this.callback!=null){this.callback(o)}}}return this},upload:function(t){if(this.options.spinner){e.cssLoader.show({urlPlugin:this.options.urlPlugin+"/getfile/libs",useLayer:false,theme:"carousel"})}var n=new FormData;if(this.options.multiple){var r=0;t.each(function(e){r+=e.size});if(this.options.maxFilesSizes!=null&&this.options.maxFilesSizes!=false&&r>this.options.maxFilesSizes){if(this.options.spinner)e.cssLoader.hide();var i=r/1048576;var s=this.options.maxFilesSizes/1048576;var o={success:false,error:16,message:"The files whith weighing "+i.toFixed(2)+" Mb they does not been uploaded to the server, to exceed the maximum files sizes allowed of "+s.toFixed(2)+" Mb"};this.callback(o);return false}var u=0;var o=new Array;t.each(function(e){if(this.options.maxFileSize!=null&&this.options.maxFileSize!=false&&e.size>this.options.maxFileSize){var t=e.size/1048576;var r=this.options.maxFileSize/1048576;o.push({success:false,error:15,message:"The file "+e.name+" weighing "+t.toFixed(2)+" Mb has not been uploaded to the server, to exceed the maximum file size allowed of "+r.toFixed(2)+" Mb"})}else{n.append("file"+u,e.nativeFile);u++}}.bind(this));if(u>0){if(o.length>0){this.properties.response=o}n.append("nFiles",u)}else{if(this.options.spinner)e.cssLoader.hide();o={success:false,multiple:true,files:o};this.callback(o);return false}}else{var a=t.first();if(this.options.maxFileSize!=null&&this.options.maxFileSize!=false&&a.size>this.options.maxFileSize||this.options.maxFilesSizes!=null&&this.options.maxFilesSizes!=false&&a.size>this.options.maxFilesSizes){if(this.options.spinner)e.cssLoader.hide();var i=event.target.files[0].size/1048576;var s=this.options.maxFileSize/1048576;var o={success:false,error:15,message:"The file "+event.target.files[0].name+" weighing "+i.toFixed(2)+" Mb has not been uploaded to the server, to exceed the maximum file size allowed of "+s.toFixed(2)+" Mb"};this.callback(o);return false}else{n.append("file",a.nativeFile)}}n.append("multiple",this.options.multiple);n.append("action","upload");n.append("folder",this.options.folder);n.append("tmpFolder",this.options.tmpFolder);n.append("cropActive",this.options.crop.active);n.append("resizeActive",this.options.resize.active);n.append("outputExtension",this.options.outputExtension);n.append("encryption",this.options.encryption);n.append("filename",this.options.filename);n.append("mimesAccept",this.options.mimesAccept);n.append("tmpDelete",this.properties.tmpDelete);e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",data:n,type:"POST",dataType:"json",context:this,cache:false,contentType:false,processData:false,xhr:function(){var e=new window.XMLHttpRequest;e.upload.addEventListener("progress",function(e){if(e.lengthComputable){if(this.callback!=null){var t=e.loaded/e.total*100|0;var n={success:true,action:"loading",total:e.total,loaded:e.loaded,percentage:t};this.callback(n)}}}.bind(this.context),false);return e},error:function(n){if(this.options.spinner)e.cssLoader.hide();if(this.options.multiple){var r=new Array;var i=this;e.each(t,function(e,t){var n=t.size/1048576;var s={success:false,error:13,message:"The file "+t.name+" weighing "+n.toFixed(2)+" Mb has not been uploaded to the server, to exceed the maximum file size allowed to server: "+i.properties.phpIni.postMaxSize};r.push(s)});this.callback(r)}else{var s=t.first();var o=s.size/1048576;var r={success:false,error:13,message:"The file "+s.name+" weighing "+o.toFixed(2)+" Mb has not been uploaded to the server, to exceed the maximum file size allowed to server:"+this.properties.phpIni.postMaxSize};this.callback(r)}},success:function(t){if(this.options.multiple){this.properties.files=t.files}else{this.properties.tmpName=t.name;this.properties.size=t.size;this.properties.oldName=t.oldName;this.properties.extension=t.extension;this.properties.mime=t.mime;this.properties.isImage=t.isImage}if(this.options.crop.active&&t.isImage&&this.options.multiple==false){this.properties.width=t.width;this.properties.height=t.height;this.properties.pixelRatio=window.devicePixelRatio;e.colorbox({inline:true,href:this.items.container,width:"100%",height:"100%",scrolling:false});var n=e("#cboxLoadedContent"),r=e("#gfPreview"),i=e("#gfFooter"),s=n.width(),u=n.height(),a=false;if(e(window).width()*this.properties.pixelRatio>990){var f=s-70;this.properties.mow=Math.round(f*.7);this.properties.mpw=Math.round(f*.3);a=true}else{var f=s;this.properties.mow=Math.round(f*.9);this.properties.mpw=Math.round(f*.6);a=false}if(!MobileEsp.DetectTierTablet()&&!MobileEsp.DetectTierIphone()){this.properties.moh=u-110}this.crop(this.options.tmpFolder+"/"+t.name);r.removeClass();i.removeClass();if(a){r.addClass("gf-horizontal")}else{r.addClass("gf-vertical");i.addClass("gf-vertical");var l=Math.round(this.properties.mph+this.properties.moh+175);e.colorbox.resize({width:"100%",height:l})}}else if(this.options.resize.active&&t.isImage||this.options.resize.active&&this.options.multiple==true){if(this.options.multiple){var c=false;for(var h=0;h<this.properties.files.length;h++){if(this.properties.files[h].isImage==true){h=this.properties.files.length;c=true;this.executeResize()}}if(!c&&this.callback!=null)this.callback(t)}else{this.executeResize()}}else if(this.options.outputExtension!=null&&t.isImage||this.options.outputExtension!=null&&this.options.multiple==true){if(this.options.multiple){var c=false;for(var h=0;h<this.properties.files.length;h++){if(this.properties.files[h].isImage==true){h=this.properties.files.length;c=true;this.executeChangeExtension()}}if(!c&&this.callback!=null)this.callback(t)}else{this.executeChangeExtension()}}else if(this.options.copies.length>0&&t.isImage||this.options.copies.length>0&&this.options.multiple==true){if(this.options.multiple){var c=false;for(var h=0;h<this.properties.files.length;h++){if(this.properties.files[h].isImage==true){h=this.properties.files.length;c=true;this.executeCopies(t)}}if(!c&&this.callback!=null)this.callback(t)}else{this.executeCopies(t)}}else{if(this.callback!=null){if(this.options.multiple){e.merge(t.files,o)}this.callback(t)}}if(this.options.spinner)e.cssLoader.hide()}})},crop:function(t){if(!e.Jcrop){var n={success:false,error:3,message:"JCrop library not loaded"};if(this.callback!=null){this.callback(n)}}this.removeCrop();if(this.options.crop.height&&this.options.crop.width){this.options.crop.aspectRatio=this.options.crop.width/this.options.crop.height}else{if(isNaN(this.options.crop.aspectRatio)){var n={success:false,error:4,message:"Width and Height or Ratio must be defined"};if(this.callback!=null){this.callback(n)}}}if(this.options.crop.aspectRatio>=1){this.properties.rpw=this.properties.mpw;this.properties.rph=Math.round(this.properties.rpw/this.options.crop.aspectRatio)}else{this.properties.rph=this.properties.mph;this.properties.rpw=Math.round(this.properties.rph*this.options.crop.aspectRatio);if(this.properties.rpw>this.properties.mpw){this.properties.rpw=this.properties.mpw;this.properties.rph=Math.round(this.properties.rpw/this.options.crop.aspectRatio)}}this.properties.mph=this.properties.rph;var r=this.properties.width/this.properties.height;if(this.properties.width>this.properties.mow){this.properties.row=this.properties.mow;this.properties.roh=Math.round(this.properties.mow/r)}else{this.properties.row=this.properties.width;this.properties.roh=this.properties.height}if(this.properties.roh>this.properties.moh){this.properties.roh=this.properties.moh;this.properties.row=Math.round(this.properties.moh*r)}this.properties.moh=this.properties.roh;this.items.preview.css({width:this.properties.rpw+"px",height:this.properties.rph+"px"});this.items.crop.css({width:this.properties.mow+4+"px",height:this.properties.moh+"px"});e('<img id="imgOrig" width="'+this.properties.row+'" height="'+this.properties.roh+'" src="'+t+'">').appendTo(this.items.crop);e('<img id="imgPreview" src="'+t+'">').appendTo(this.items.preview);e("#imgOrig").Jcrop({onChange:e.proxy(this.showPreview,this),onSelect:e.proxy(this.showPreview,this),bgColor:"black",bOpacity:.65,aspectRatio:this.options.crop.aspectRatio,minSize:this.options.crop.minSize,maxSize:this.options.crop.maxSize,setSelect:this.options.crop.setSelect});var i=!!navigator.userAgent.match(/Trident.*rv[ :]*11\./);if(i){this.properties.tmpNameIE11=this.properties.tmpName;this.properties.sizeIE11=this.properties.size;this.properties.oldNameIE11=this.properties.oldName;this.properties.extensionIE11=this.properties.extension;this.properties.mimeIE11=this.properties.mime;this.properties.isImageIE11=this.properties.isImage}this.items.cropButton.on("click",e.proxy(this.executeCrop,this));this.items.cancelButton.on("click",function(){e.colorbox.close()})},removeCrop:function(){e(this.items.crop).html("");e(this.items.preview).html("");this.items.cropButton.off("click");this.items.cancelButton.off("click")},showPreview:function(t){var n=this.properties.rpw/t.w;var r=this.properties.rph/t.h;e("#imgPreview").css({width:Math.round(n*e("#imgOrig").width())+"px",height:Math.round(r*e("#imgOrig").height())+"px",marginLeft:"-"+Math.round(n*t.x)+"px",marginTop:"-"+Math.round(r*t.y)+"px"});this.properties.coords=t},executeCrop:function(){e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:false,data:{action:"crop",tmpName:this.properties.tmpName==undefined?this.properties.tmpNameIE11:this.properties.tmpName,size:this.properties.size==undefined?this.properties.sizeIE11:this.properties.size,oldName:this.properties.oldName==undefined?this.properties.oldNameIE11:this.properties.oldName,extension:this.properties.extension==undefined?this.properties.extensionIE11:this.properties.extension,mime:this.properties.mime==undefined?this.properties.mimeIE11:this.properties.mime,isImage:this.properties.isImage==undefined?this.properties.isImageIE11:this.properties.isImage,coords:this.properties.coords,cropWidth:this.options.crop.width,cropHeight:this.options.crop.height,aspectRatio:this.options.crop.aspectRatio,tmpFolder:this.options.tmpFolder,folder:this.options.folder,row:this.properties.row,roh:this.properties.roh,outputExtension:this.options.outputExtension,copies:this.options.copies},success:function(t){e.colorbox.close();if(this.callback!=null){this.callback(t)}},error:function(e){if(this.callback!=null){this.callback(e.responseJSON)}}})},executeResize:function(){if(this.options.multiple){var t={action:"resize",multiple:true,files:this.properties.files,tmpFolder:this.options.tmpFolder,folder:this.options.folder,width:this.options.resize.width,height:this.options.resize.height,constrainProportions:this.options.resize.constrainProportions,outputExtension:this.options.outputExtension,copies:this.options.copies}}else{var t={action:"resize",multiple:false,tmpName:this.properties.tmpName,size:this.properties.size,oldName:this.properties.oldName,extension:this.properties.extension,mime:this.properties.mime,isImage:this.properties.isImage,tmpFolder:this.options.tmpFolder,folder:this.options.folder,width:this.options.resize.width,height:this.options.resize.height,constrainProportions:this.options.resize.constrainProportions,outputExtension:this.options.outputExtension,copies:this.options.copies}}e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:false,data:t,success:function(t){if(this.callback!=null){if(this.options.multiple&&this.properties.response!=null){e.merge(t.files,this.properties.response)}this.callback(t)}},error:function(e){if(this.callback!=null){this.callback(e.responseJSON)}}})},executeChangeExtension:function(){if(this.options.multiple){var t={action:"change",multiple:true,files:this.properties.files,tmpFolder:this.options.tmpFolder,folder:this.options.folder,outputExtension:this.options.outputExtension,copies:this.options.copies}}else{var t={action:"change",multiple:false,tmpName:this.properties.tmpName,size:this.properties.size,oldName:this.properties.oldName,extension:this.properties.extension,mime:this.properties.mime,isImage:this.properties.isImage,tmpFolder:this.options.tmpFolder,folder:this.options.folder,outputExtension:this.options.outputExtension,copies:this.options.copies}}e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:false,data:t,success:function(t){if(this.callback!=null){if(this.options.multiple&&this.properties.response!=null){e.merge(t.files,this.properties.response)}this.callback(t)}},error:function(e){if(this.callback!=null){this.callback(e.responseJSON)}}})},executeCopies:function(t){if(this.options.multiple){t.action="copies";t.multiple=true;t.files=this.properties.files,t.folder=this.options.folder;t.copies=this.options.copies}else{t.action="copies";t.multiple=false;t.folder=this.options.folder;t.copies=this.options.copies}e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:false,data:t,success:function(t){if(this.callback!=null){if(this.options.multiple&&this.properties.response!=null){e.merge(t.files,this.properties.response)}this.callback(t)}},error:function(e){if(this.callback!=null){this.callback(e.responseJSON)}}})},"delete":function(t,n){e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:false,data:{action:"delete",filenames:t},success:function(e){if(n!=null){n(e)}}})}};if(typeof Object.create!=="function"){Object.create=function(e){function t(){}t.prototype=e;return new t}}e.fn.getFile=function(n,r){return this.each(function(){if(!e.data(this,"getFile")){e.data(this,"getFile",Object.create(t).init(n,r,this))}})}})(jQuery)